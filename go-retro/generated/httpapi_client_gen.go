// Code generated by GoRetro; DO NOT EDIT.
package goretro

import (
	"bytes"
	"encoding/json"
	"errors"
	"fmt"
	"github.com/AlterNayte/go-retro/example/httpbin"
	"io/ioutil"
	"log"
	"net/http"
	"time"
)

type HttpAPIClient struct {
	BaseURL        string
	HTTPClient     *http.Client
	AuthType       AuthType
	Username       string
	Password       string
	APIKey         string
	BearerToken    string
	CustomAuthFunc func() (string, error)
	CustomHeaders  map[string]string
	Timeout        time.Duration
	MaxRetries     int
}

func NewHttpAPIClient(baseURL string) *HttpAPIClient {
	return &HttpAPIClient{
		BaseURL:       baseURL,
		HTTPClient:    &http.Client{},
		AuthType:      AuthNone,
		CustomHeaders: make(map[string]string),
		Timeout:       30 * time.Second,
		MaxRetries:    3,
	}
}

func (c *HttpAPIClient) SetBasicAuth(username, password string) {
	c.AuthType = AuthBasic
	c.Username = username
	c.Password = password
}

func (c *HttpAPIClient) SetAPIKeyAuth(apiKey string) {
	c.AuthType = AuthAPIKey
	c.APIKey = apiKey
}

func (c *HttpAPIClient) SetBearerAuth(token string) {
	c.AuthType = AuthBearer
	c.BearerToken = token
}

func (c *HttpAPIClient) SetCustomAuthFunc(authFunc func() (string, error)) {
	c.CustomAuthFunc = authFunc
}

func (c *HttpAPIClient) SetCustomHeader(key, value string) {
	c.CustomHeaders[key] = value
}

func (c *HttpAPIClient) doRequest(req *http.Request) (*http.Response, error) {
	for k, v := range c.CustomHeaders {
		req.Header.Set(k, v)
	}
	req.Header.Set("Content-Type", "application/json")

	for i := 0; i < c.MaxRetries; i++ {
		c.HTTPClient.Timeout = c.Timeout
		resp, err := c.HTTPClient.Do(req)
		if err != nil {
			if i == c.MaxRetries-1 {
				return nil, err
			}
			time.Sleep(2 * time.Second)
			continue
		}

		if resp.StatusCode >= 200 && resp.StatusCode < 300 {
			return resp, nil
		}

		if i == c.MaxRetries-1 {
			bodyBytes, _ := ioutil.ReadAll(resp.Body)
			return nil, fmt.Errorf("request failed with status %d: %s", resp.StatusCode, string(bodyBytes))
		}

		time.Sleep(2 * time.Second)
	}

	return nil, errors.New("max retries exceeded")
}

func (c *HttpAPIClient) PostExample(input httpbin.PostInput) (*httpbin.PostValue, error) {
	reqURL := c.BaseURL + "/post"

	req, err := http.NewRequest("POST", reqURL, nil)
	if err != nil {
		return nil, err
	}

	bodyBytes, err := json.Marshal(input)
	if err != nil {
		return nil, err
	}
	req.Body = ioutil.NopCloser(bytes.NewBuffer(bodyBytes))
	req.Header.Set("Content-Type", "application/json")

	log.Printf("Making request to %s", req.URL)

	resp, err := c.doRequest(req)
	if err != nil {
		return nil, err
	}
	defer resp.Body.Close()

	var result *httpbin.PostValue
	if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
		return nil, err
	}

	return result, nil
}
